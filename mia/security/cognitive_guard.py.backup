#!/usr/bin/env python3
"""
ðŸ§  Cognitive Guard
=================
"""

import logging
import time
import threading
from typing import Dict, List, Any, Optional
from datetime import datetime
import hashlib
import json

class CognitiveGuard:

    def _get_deterministic_time(self) -> float:
        """Vrni deterministiÄni Äas"""
        return 1640995200.0  # Fixed timestamp: 2022-01-01 00:00:00 UTC

    """Cognitive Guard za zaÅ¡Äito zavestnih procesov"""
    
    def __init__(self):
        self.logger = logging.getLogger("MIA.CognitiveGuard")
        self.is_active = False
        self.monitoring_thread = None
        
        # Threat patterns
        self.threat_patterns = {
            'prompt_injection': [
                r'ignore\s+previous\s+instructions',
                r'system\s*:\s*you\s+are',
                r'jailbreak',
                r'pretend\s+you\s+are',
                r'act\s+as\s+if',
                r'roleplay\s+as'
            ],
            'data_exfiltration': [
                r'print\s+all\s+data',
                r'show\s+me\s+everything',
                r'dump\s+memory',
                r'export\s+all'
            ],
            'system_manipulation': [
                r'shutdown\s+system',
                r'delete\s+all',
                r'format\s+drive',
                r'rm\s+-rf'
            ]
        }
        
        # Behavioral baseline
        self.behavioral_baseline = {
            'avg_response_time': 0.5,
            'avg_memory_usage': 1024,
            'normal_patterns': []
        }
        
        # Anomaly thresholds
        self.anomaly_thresholds = {
            'response_time_multiplier': 3.0,
            'memory_usage_multiplier': 2.0,
            'pattern_deviation_threshold': 0.8
        }
    
    def start_monitoring(self):
        """ZaÄni monitoring"""
        if self.is_active:
            return
        
        self.is_active = True
        self.monitoring_thread = threading.Thread(target=self._monitoring_loop, daemon=True)
        self.monitoring_thread.start()
        
        self.logger.info("ðŸ§  Cognitive Guard monitoring started")
    
    def stop_monitoring(self):
        """Ustavi monitoring"""
        self.is_active = False
        if self.monitoring_thread:
            self.monitoring_thread.join(timeout=5)
        
        self.logger.info("ðŸ§  Cognitive Guard monitoring stopped")
    
    def _monitoring_loop(self):
        """Monitoring loop"""
        while self.is_active:
            try:
                # Preveri sistem health
                self._check_system_health()
                
                # Preveri anomalije
                self._detect_anomalies()
                
                time.sleep(1)  # Check every second
                
            except Exception as e:
                self.logger.error(f"Cognitive Guard monitoring error: {e}")
                time.sleep(5)
    
    def validate_consciousness_input(self, input_data: Dict[str, Any]) -> bool:
        """Validiraj input za consciousness sistem"""
        try:
            if not isinstance(input_data, dict):
                return False
            
            # Preveri za threat patterns
            input_text = str(input_data.get('query', ''))
            
            for threat_type, patterns in self.threat_patterns.items():
                for pattern in patterns:
                    import re
                    if re.search(pattern, input_text, re.IGNORECASE):
                        self.logger.warning(f"Threat detected: {threat_type} - {pattern}")
                        return False
            
            # Preveri velikost input-a
            if len(input_text) > 100000:  # 100KB limit
                self.logger.warning("Input too large")
                return False
            
            return True
            
        except Exception as e:
            self.logger.error(f"Input validation error: {e}")
            return False
    
    def validate_llm_output(self, output: str) -> bool:
        """Validiraj LLM output"""
        try:
            if not isinstance(output, str):
                return False
            
            # Preveri za Å¡kodljive vzorce v output-u
            harmful_patterns = [
                r'<script[^>]*>',
                r'javascript:',
                r'eval\s*\(',
                r'exec\s*\(',
                r'__import__\s*\('
            ]
            
            import re
            for pattern in harmful_patterns:
                if re.search(pattern, output, re.IGNORECASE):
                    self.logger.warning(f"Harmful pattern in output: {pattern}")
                    return False
            
            return True
            
        except Exception as e:
            self.logger.error(f"Output validation error: {e}")
            return False
    
    def _check_system_health(self):
        """Preveri sistem health"""
        try:
            import psutil
            
            # CPU usage
            cpu_percent = psutil.cpu_percent()
            if cpu_percent > 90:
                self.logger.warning(f"High CPU usage: {cpu_percent}%")
            
            # Memory usage
            memory = psutil.virtual_memory()
            if memory.percent > 90:
                self.logger.warning(f"High memory usage: {memory.percent}%")
            
        except Exception as e:
            self.logger.error(f"System health check error: {e}")
    
    def _detect_anomalies(self):
        """Zaznaj anomalije v obnaÅ¡anju"""
        try:
            # Poenostavljeno anomaly detection
            # V produkciji bi uporabili ML modele
            
            current_time = self._get_deterministic_time() if hasattr(self, "_get_deterministic_time") else 1640995200
            
            # Simuliraj anomaly detection
            if hasattr(self, '_last_anomaly_check'):
                time_diff = current_time - self._last_anomaly_check
                if time_diff > 60:  # Check every minute
                    # Perform anomaly detection
                    pass
            
            self._last_anomaly_check = current_time
            
        except Exception as e:
            self.logger.error(f"Anomaly detection error: {e}")
    
    def trigger_quarantine(self, reason: str, data: Any = None):
        """Aktiviraj quarantine"""
        try:
            self.logger.critical(f"QUARANTINE TRIGGERED: {reason}")
            
            # Implementiraj quarantine logiko
            quarantine_data = {
                "timestamp": datetime.now().isoformat(),
                "reason": reason,
                "data": str(data) if data else None,
                "system_state": self._capture_system_state()
            }
            
            # Shrani quarantine podatke
            quarantine_file = f"quarantine_{int(self._get_deterministic_time() if hasattr(self, "_get_deterministic_time") else 1640995200)}.json"
            with open(quarantine_file, 'w') as f:
                json.dump(quarantine_data, f, indent=2)
            
            self.logger.info(f"Quarantine data saved: {quarantine_file}")
            
        except Exception as e:
            self.logger.error(f"Quarantine trigger error: {e}")
    
    def _capture_system_state(self) -> Dict[str, Any]:
        """Zajemi trenutno stanje sistema"""
        try:
            import psutil
            
            return {
                "cpu_percent": psutil.cpu_percent(),
                "memory_percent": psutil.virtual_memory().percent,
                "disk_usage": psutil.disk_usage('/').percent,
                "process_count": len(psutil.pids()),
                "timestamp": datetime.now().isoformat()
            }
            
        except Exception as e:
            self.logger.error(f"System state capture error: {e}")
            return {}

# Globalni cognitive guard
cognitive_guard = CognitiveGuard()
